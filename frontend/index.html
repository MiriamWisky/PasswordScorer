<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>××—×©×‘×•×Ÿ ×—×•×–×§ ×¡×™×¡××”</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { 
            max-width: 700px; 
            margin: 0 auto; 
            padding: 30px; 
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        input[type="text"] { 
            padding: 15px; 
            width: 100%; 
            margin-bottom: 20px; 
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        button { 
            padding: 12px 20px; 
            font-size: 14px; 
            cursor: pointer; 
            border: none; 
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 600;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-info { background: #17a2b8; color: white; }
        
        #results { 
            margin-top: 30px; 
            padding: 20px; 
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            text-align: right; 
        }
        .weak { color: #dc3545; font-weight: bold; }
        .medium { color: #fd7e14; font-weight: bold; }
        .strong { color: #28a745; font-weight: bold; }
        
        #historyResults {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        #historyList {
            list-style: none;
            padding: 0;
        }
        #historyList li {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">

        
       
        <h2>××—×©×‘×•×Ÿ ×—×•×–×§ ×¡×™×¡××” ×•×—×™×–×•×™ ×¤×™×¦×•×— ğŸ”‘</h2>
        <input type="text" id="passwordInput" placeholder="×”×›× ×¡ ×¡×™×¡××” ×›××Ÿ..." onkeyup="if(this.value.length > 0) checkPassword(false)"> 

        <div class="button-group">
            <button class="btn-primary" onclick="checkPassword(true)">×‘×“×™×§×” ×•×©××™×¨×”</button>
            <button class="btn-warning" onclick="generatePassword()">×’× ×¨×¦×™×” ×¡×™×¡××” ×—×–×§×”</button>
            <button class="btn-success" onclick="showHistory()">×”×¦×’ ×”×™×¡×˜×•×¨×™×”</button>
            <button class="btn-info" onclick="generatePoem()" style="background: #e91e63;">ğŸµ ×¦×•×¨ ×©×™×¨ ×œ×¡×™×¡××”</button>
            <button class="btn-info" onclick="logout()">×”×ª× ×ª×§×•×ª</button>
        </div>

        <div id="results">
            <strong>×ª×•×¦××•×ª ×‘×“×™×§×”:</strong>
            <p id="scoreLevel">×¨××ª ×—×•×–×§: <span class="weak">...</span></p>
            <p id="crackingTime">×–××Ÿ ×¤×™×¦×•×— ×—×–×•×™: <span>...</span></p>
            <p id="statusMessage">×”×ª×•×¦××•×ª × ×©××¨×• ×‘×‘×¡×™×¡ ×”× ×ª×•× ×™× (PostgreSQL).</p>
        </div>

        <div id="historyResults" style="display: none;">
            <h4>×”×™×¡×˜×•×¨×™×™×ª 10 ×”×¡×™×¡×××•×ª ×”××—×¨×•× ×•×ª:</h4>
            <ul id="historyList"></ul>
        </div>
        
        <div id="poemResults" style="display: none; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); padding: 20px; border-radius: 10px; margin-top: 20px;">
            <div id="poemContent" style="white-space: pre-line; font-family: 'Courier New', monospace; font-size: 16px; color: #444; line-height: 1.6;"></div>
            <p style="font-size: 12px; color: #666; margin-top: 15px;">âš ï¸ ×”×©×™×¨ × ×•×¦×¨ ××¨××–×™× ×‘×œ×‘×“ - ×”×¡×™×¡××” ×”×××™×ª×™×ª ×œ× × ×©×œ×—×” ×œ-AI</p>
        </div>
        
    </div>

    <script>
        // ×‘×“×™×§×ª ×”×ª×—×‘×¨×•×ª ×‘×˜×¢×™× ×ª ×”×¢××•×“
        window.addEventListener('load', function() {
            checkAuthStatus();
        });
        
        async function checkAuthStatus() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            try {
                const response = await fetch('/history', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.log('Auth check failed');
            }
        }
        
        async function logout() {
            const token = localStorage.getItem('token');
            try {
                await fetch('/logout', { 
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            } catch (error) {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        }
        
        // ×¤×•× ×§×¦×™×” ××—×ª ××˜×¤×œ×ª ×‘×©× ×™ ×”××¦×‘×™×: ×‘×“×™×§×” ××™×™×“×™×ª (false) ××• ×©××™×¨×” (true)
    async function checkPassword(saveToDb) {
        const password = document.getElementById('passwordInput').value;
        const scoreLevelElement = document.getElementById('scoreLevel');
        const crackingTimeElement = document.getElementById('crackingTime');
        const statusMessageElement = document.getElementById('statusMessage');

        if (password.length === 0) {
            scoreLevelElement.innerHTML = '×¨××ª ×—×•×–×§: <span class="weak">...</span>';
            crackingTimeElement.innerHTML = '×–××Ÿ ×¤×™×¦×•×— ×—×–×•×™: <span>...</span>';
            statusMessageElement.textContent = '';
            return;
        }
        
        // ×‘×•× ×” ××ª ×’×•×£ ×”×‘×§×©×”, ×›×•×œ×œ ×”×“×’×œ save_to_db
        const payload = { 
            password: password, 
            save_to_db: saveToDb // True ××• False
        };
        
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            // ×©×•×œ×— ×‘×§×©×” ×œ× ×ª×™×‘ ×”×¨××©×™
            const response = await fetch('/score', { 
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload) 
            });

            // Handle different response statuses
            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
                return;
            }
            
            if (response.status === 503) {
                scoreLevelElement.innerHTML = '×¨××ª ×—×•×–×§: <span class="weak">×©×’×™××” ×–×× ×™×ª</span>';
                crackingTimeElement.innerHTML = '×–××Ÿ ×¤×™×¦×•×— ×—×–×•×™: <span>× ×¡×” ×©×•×‘</span>';
                statusMessageElement.textContent = '×”×©×¨×ª ×¢××•×¡, × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢';
                return;
            }
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            
            if (data.error) {
                scoreLevelElement.innerHTML = '×¨××ª ×—×•×–×§: <span class="weak">×©×’×™××”</span>';
                crackingTimeElement.innerHTML = '×–××Ÿ ×¤×™×¦×•×— ×—×–×•×™: <span>×œ× ×–××™×Ÿ</span>';
                statusMessageElement.textContent = `×©×’×™××”: ${data.error}`;
                return;
            }
            
            // ×¢×“×›×•×Ÿ ×”-UI ×¢× ×”×—×•×–×§ ×•×–××Ÿ ×”×¤×™×¦×•×—
            let strengthClass = 'weak';
            let strengthText = '×œ× ×™×“×•×¢';
            
            if (data.strength === 0) {
                strengthClass = 'weak';
                strengthText = '×—×œ×©×”';
            } else if (data.strength === 1) {
                strengthClass = 'medium';
                strengthText = '×‘×™× ×•× ×™×ª';
            } else if (data.strength === 2) {
                strengthClass = 'strong';
                strengthText = '×—×–×§×”';
            }
            
            scoreLevelElement.innerHTML = `×¨××ª ×—×•×–×§: <span class="${strengthClass}">${strengthText}</span>`;
            crackingTimeElement.innerHTML = `×–××Ÿ ×¤×™×¦×•×— ×—×–×•×™: <span>${data.crack_time}</span>`;
            
            if (saveToDb) {
                statusMessageElement.textContent = `×”×¡×™×¡××” × ×©××¨×” ×‘×‘×¡×™×¡ ×”× ×ª×•× ×™× (×—×•×–×§: ${strengthText}).`;
            } else {
                statusMessageElement.textContent = '×‘×“×™×§×” ×‘×œ×‘×“ - ×œ× × ×©××¨ ×‘×‘×¡×™×¡ ×”× ×ª×•× ×™×.';
            }
            
            // × ×™×§×•×™ ×”×˜×§×¡×˜ ×‘×•×§×¡ ××—×¨×™ ×©××™×¨×”
            if (data.clear_input) {
                document.getElementById('passwordInput').value = '';
            }
            
        } catch (error) {
            scoreLevelElement.innerHTML = '×¨××ª ×—×•×–×§: <span class="weak">×©×’×™××”</span>';
            crackingTimeElement.innerHTML = '×–××Ÿ ×¤×™×¦×•×— ×—×–×•×™: <span>×œ× ×–××™×Ÿ</span>';
            statusMessageElement.textContent = '×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ ×—×•×–×§ ×¡×™×¡××”.';
            console.error('Check Error:', error);
        }
    }

        // ×¤×•× ×§×¦×™×” ×œ×’× ×¨×¦×™×” ×©×œ ×¡×™×¡××” ××•××œ×¦×ª
    async function generatePassword() {
        const passwordInput = document.getElementById('passwordInput');
        const scoreLevelElement = document.getElementById('scoreLevel');
        const crackingTimeElement = document.getElementById('crackingTime');
        const statusMessageElement = document.getElementById('statusMessage');
        
        statusMessageElement.textContent = '××’× ×¨ ×¡×™×¡××” ××•××œ×¦×ª...';
        
        try {
            const response = await fetch('/recommend', { 
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            const data = await response.json();
            
            if (data.error) {
                statusMessageElement.textContent = `×©×’×™××”: ${data.error}`;
                return;
            }
            
            // ×”×›× ×¡×ª ×”×¡×™×¡××” ×œ×©×“×” ×”×˜×§×¡×˜
            passwordInput.value = data.password;
            
            // ×¢×“×›×•×Ÿ ×”×ª×•×¦××•×ª
            let strengthClass = 'weak';
            let strengthText = '×œ× ×™×“×•×¢';
            
            if (data.strength === 0) {
                strengthClass = 'weak';
                strengthText = '×—×œ×©×”';
            } else if (data.strength === 1) {
                strengthClass = 'medium';
                strengthText = '×‘×™× ×•× ×™×ª';
            } else if (data.strength === 2) {
                strengthClass = 'strong';
                strengthText = '×—×–×§×”';
            }
            
            scoreLevelElement.innerHTML = `×¨××ª ×—×•×–×§: <span class="${strengthClass}">${strengthText}</span>`;
            crackingTimeElement.innerHTML = `×–××Ÿ ×¤×™×¦×•×— ×—×–×•×™: <span>${data.crack_time}</span>`;
            // ×‘×“×™×§×” ×× ×”×¡×™×¡××” ××‘×•×¡×¡×ª ×¢×œ ×“×¤×•×¡×™× ×§×™×™××™×
            const isBasedOnHistory = data.password.includes('miriam') || data.password.includes('miri');
            if (isBasedOnHistory) {
                statusMessageElement.textContent = '×¡×™×¡××” ×—×–×§×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”! (××‘×•×¡×¡ ×¢×œ ×”×¡×™×¡×××•×ª ×©×œ×š)';
            } else {
                statusMessageElement.textContent = '×¡×™×¡××” ×—×–×§×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!';
            }
            
        } catch (error) {
            statusMessageElement.textContent = '×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×’× ×¨×¨ ×¡×™×¡××” ××•××œ×¦×ª.';
            console.error('Generate Password Error:', error);
        }
    }

        // ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×”×¦×’×ª ×”×”×™×¡×˜×•×¨×™×”
    async function showHistory() {
        const historyList = document.getElementById('historyList');
        const historyResultsDiv = document.getElementById('historyResults');
        historyList.innerHTML = '×˜×•×¢×Ÿ...';
        historyResultsDiv.style.display = 'block';

        try {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            const response = await fetch('/history', { 
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
                return;
            }
            
            if (response.status === 503) {
                historyList.innerHTML = '<li>×”×©×¨×ª ×¢××•×¡, × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢</li>';
                return;
            }
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();

            historyList.innerHTML = ''; // ×× ×§×” ××ª ×¨×©×™××ª ×”×˜×¢×™× ×”

            if (response.ok && Array.isArray(data)) {
                if (data.length === 0) {
                    historyList.innerHTML = '<li>×œ× × ××¦××• ×‘×“×™×§×•×ª ×§×•×“××•×ª.</li>';
                } else {
                    data.forEach(item => {
                        const li = document.createElement('li');
                        // ×©×™× ×™× ×• ×-Hash ×œ-Password
                        li.textContent = `×—×•×–×§: ${item.strength_level} | ×¡×™×¡××”: ${item.password} | ×–××Ÿ: ${new Date(item.timestamp).toLocaleString()}`;
                        historyList.appendChild(li);
                    });
                }
            } else {
                historyList.innerHTML = `<li>×©×’×™××” ×‘×©×œ×™×¤×ª × ×ª×•× ×™×: ${data.error || '×œ× ×™×“×•×¢'}</li>`;
            }
        } catch (error) {
            historyList.innerHTML = `<li>×©×’×™××ª ×¨×©×ª: ×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×©×¨×ª.</li>`;
            console.error('History Fetch Error:', error);
        }
    }
    
    // ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×™×¦×™×¨×ª ×©×™×¨ AI
    async function generatePoem() {
        const password = document.getElementById('passwordInput').value;
        const poemResultsDiv = document.getElementById('poemResults');
        const poemContent = document.getElementById('poemContent');
        
        if (!password || password.length < 4) {
            alert('×”×›× ×¡ ×¡×™×¡××” (×œ×¤×—×•×ª 4 ×ª×•×•×™×) ×œ×™×¦×™×¨×ª ×©×™×¨!');
            return;
        }
        
        poemResultsDiv.style.display = 'block';
        poemContent.textContent = '×™×•×¦×¨ ×©×™×¨ ×××•×‘×˜×— ×¢×‘×•×¨×š... ğŸµâœ¨';
        
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            const response = await fetch('/password-poem', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ password: password })
            });
            
            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
                return;
            }
            
            if (response.status === 503) {
                poemContent.textContent = '×”×©×¨×ª ×¢××•×¡, × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢...';
                return;
            }
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
                poemContent.textContent = `×©×’×™××”: ${data.error}`;
                return;
            }
            
            poemContent.textContent = data.poem;
            
        } catch (error) {
            poemContent.textContent = '×©×’×™××” ×‘×™×¦×™×¨×ª ×”×©×™×¨. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.';
            console.error('Poem Generation Error:', error);
        }
    }
    </script>
</body>
</html>